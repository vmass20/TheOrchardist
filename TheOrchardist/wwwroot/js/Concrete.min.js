(function(){var n={},t=0;n.pixelRatio=function(){return window&&window.navigator&&window.navigator.userAgent&&!/PhantomJS/.test(window.navigator.userAgent)?2:1}();n.viewports=[];n.Viewport=function(i){i||(i={});this.container=i.container;this.layers=[];this.id=t++;this.scene=new n.Scene;this.setSize(i.width||0,i.height||0);i.container.innerHTML="";i.container.appendChild(this.scene.canvas);n.viewports.push(this)};n.Viewport.prototype={add:function(n){return this.layers.push(n),n.setSize(n.width||this.width,n.height||this.height),n.viewport=this,this},setSize:function(n,t){return this.width=n,this.height=t,this.scene.setSize(n,t),this},getIntersection:function(n,t){for(var u=this.layers,e=u.length,f,r,i=e-1;i>=0;i--)if(f=u[i],r=f.hit.getIntersection(n,t),r!==null)return r;return null},getIndex:function(){for(var i=n.viewports,u=i.length,t=0,r,t=0;t<u;t++)if(r=i[t],this.id===r.id)return t;return null},destroy:function(){this.layers.forEach(function(n){n.destroy()});this.container.innerHTML="";n.viewports.splice(this.getIndex(),1)},render:function(){var n=this.scene;n.clear();this.layers.forEach(function(t){t.visible&&n.context.drawImage(t.scene.canvas,0,0,t.width,t.height)})}};n.Layer=function(i){i||(i={});this.x=0;this.y=0;this.width=0;this.height=0;this.visible=!0;this.id=t++;this.hit=new n.Hit;this.scene=new n.Scene;i.x&&i.y&&this.setPosition(i.x,i.y);i.width&&i.height&&this.setSize(i.width,i.height)};n.Layer.prototype={setPosition:function(n,t){return this.x=n,this.y=t,this},setSize:function(n,t){return this.width=n,this.height=t,this.scene.setSize(n,t),this.hit.setSize(n,t),this},moveUp:function(){var n=this.getIndex(),i=this.viewport,t=i.layers;return n<t.length-1&&(t[n]=t[n+1],t[n+1]=this),this},moveDown:function(){var n=this.getIndex(),i=this.viewport,t=i.layers;return n>0&&(t[n]=t[n-1],t[n-1]=this),this},moveToTop:function(){var t=this.getIndex(),i=this.viewport,n=i.layers;n.splice(t,1);n.push(this)},moveToBottom:function(){var t=this.getIndex(),i=this.viewport,n=i.layers;return n.splice(t,1),n.unshift(this),this},getIndex:function(){for(var t=this.viewport.layers,r=t.length,n=0,i,n=0;n<r;n++)if(i=t[n],this.id===i.id)return n;return null},destroy:function(){this.viewport.layers.splice(this.getIndex(),1)}};n.Scene=function(i){i||(i={});this.width=0;this.height=0;this.pixelRatio=i.pixelRatio||n.pixelRatio;this.id=t++;this.canvas=document.createElement("canvas");this.canvas.className="concrete-scene-canvas";this.canvas.style.display="inline-block";this.context=this.canvas.getContext("2d");i.width&&i.height&&this.setSize(i.width,i.height)};n.Scene.prototype={setSize:function(n,i){return this.width=n,this.height=i,this.id=t++,this.canvas.width=n*this.pixelRatio,this.canvas.style.width=n+"px",this.canvas.height=i*this.pixelRatio,this.canvas.style.height=i+"px",this.pixelRatio!==1&&this.context.scale(this.pixelRatio,this.pixelRatio),this},clear:function(){return this.context.clearRect(0,0,this.width*this.pixelRatio,this.height*this.pixelRatio),this},toImage:function(n){var i=this,t=new Image,r=this.canvas.toDataURL("image/png");t.onload=function(){t.width=i.width;t.height=i.height;n(t)};t.src=r},download:function(n){this.canvas.toBlob(function(t){var i=document.createElement("a"),r=URL.createObjectURL(t),u=n.fileName||"canvas.png";i.setAttribute("href",r);i.setAttribute("target","_blank");i.setAttribute("download",u);document.createEvent?(evtObj=document.createEvent("MouseEvents"),evtObj.initEvent("click",!0,!0),i.dispatchEvent(evtObj)):i.click&&i.click()})}};n.Hit=function(n){n||(n={});this.width=0;this.height=0;this.canvas=document.createElement("canvas");this.canvas.className="concrete-hit-canvas";this.canvas.style.display="none";this.canvas.style.position="relative";this.context=this.canvas.getContext("2d");this.hitColorIndex=0;this.keyToColor={};this.colorToKey={};n.width&&n.height&&this.setSize(n.width,n.height)};n.Hit.prototype={setSize:function(n,t){return this.width=n,this.height=t,this.canvas.width=n,this.canvas.style.width=n+"px",this.canvas.height=t,this.canvas.style.height=t+"px",this},clear:function(){return this.context.clearRect(0,0,this.width,this.height),this},getIntersection:function(n,t){var i,u,f,e,o,s,r;return i=this.context.getImageData(Math.round(n),Math.round(t),1,1).data,u=i[0],e=i[1],f=i[2],o=i[3],s=this.rgbToInt(u,e,f),r=this.colorToKey[s],r!==undefined&&o===255?r:null},registerKey:function(n){var t;return this.keyToColor[n]||(t=this.hitColorIndex++,this.colorToKey[t]=n,this.keyToColor[n]=t),this},rgbToInt:function(n,t,i){return(n<<16)+(t<<8)+i},getColorFromKey:function(n){var t;for(this.registerKey(n),t=this.keyToColor[n].toString(16);t.length<6;)t="0"+t;return"#"+t}};window.Concrete=n})();